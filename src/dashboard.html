<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel de control para publicar autom√°ticamente URLs en una fanpage de Facebook. Multi-proyecto, generaci√≥n de contenido con IA e integraci√≥n con Facebook Graph API.">
    <title>Facebook Auto-Publisher - Panel de Control Multi-Proyecto</title>
    <!--
        Dashboard UI styles moved to a separate file for better organization.
        Archivo: /src/dashboard.css
        Referencias:
        - README: https://github.com/Jorguitouy/Facebook-Autopost-Cloudflare#readme
        - Gu√≠a de Autorizaci√≥n: GUIA-AUTORIZACION-FACEBOOK.md
        - Gu√≠a Open Graph: OPEN-GRAPH-GUIDE.md
    -->
    <link rel="stylesheet" href="/dashboard.css">
    
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span>üìò</span>
                <span>Facebook Auto-Publisher</span>
            </div>
            <div class="header-actions">
                <button onclick="window.location.href='/account'">üë§ Mi Cuenta</button>
                <button onclick="refreshAll()">üîÑ Actualizar</button>
                <button class="success" onclick="publishNow()">‚ñ∂Ô∏è Publicar Ahora</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('projects')">üìÅ Proyectos</button>
            <button class="tab" onclick="showTab('posts')">üìù Posts</button>
            <button class="tab" onclick="showTab('ai')">ü§ñ Generador IA</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Configuraci√≥n</button>
        </div>

        <!-- Message Box -->
        <div id="message" class="message"></div>

        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Proyectos</h3>
                    <div class="value" id="totalProjects">0</div>
                </div>
                <div class="stat-card">
                    <h3>Proyectos Activos</h3>
                    <div class="value" id="activeProjects">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Posts</h3>
                    <div class="value" id="totalPosts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Pendientes</h3>
                    <div class="value" id="pendingPosts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Publicados</h3>
                    <div class="value" id="publishedPosts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Errores</h3>
                    <div class="value" id="errorPosts">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>üìà Resumen de Proyectos</h2>
                </div>
                <div id="projectsSummary"></div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="tab-projects" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>‚ûï Crear Nuevo Proyecto</h2>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre del Proyecto *</label>
                        <input type="text" id="projectName" placeholder="Mi Sitio Web">
                        <small>Nombre descriptivo para identificar el proyecto</small>
                    </div>
                    <div class="form-group">
                        <label>Dominio *</label>
                        <input type="text" id="projectDomain" placeholder="www.misitio.com">
                        <small>Dominio principal del sitio web</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="projectDescription" placeholder="Describe el contenido o tem√°tica de este proyecto..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>URLs del Proyecto (una por l√≠nea)</label>
                    <textarea id="projectUrls" rows="8" placeholder="https://www.misitio.com/pagina1&#10;https://www.misitio.com/pagina2&#10;https://www.misitio.com/pagina3"></textarea>
                    <small>Pega todas las URLs de tu sitio, una por l√≠nea (puedes agregar hasta 500 URLs)</small>
                </div>
                
                <div class="form-group">
                    <label>ü§ñ Prompt para la IA (opcional)</label>
                    <textarea id="projectAiPrompt" rows="5" placeholder="Ej: Crea posts sobre servicios t√©cnicos de calefones. Usa tono profesional pero cercano. Menciona que somos especialistas con +10 a√±os de experiencia. Incluye emojis y hashtags #servicio #calefones #uruguay"></textarea>
                    <small>Describe c√≥mo quieres que la IA genere el contenido de tus publicaciones. Esto se aplicar√° a todas las URLs de este proyecto.</small>
                </div>
                
                <div class="form-grid">
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="projectAiEnabled" checked>
                        <label>Habilitar generaci√≥n de contenido con IA</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="projectAutoPublish" checked>
                        <label>Publicar autom√°ticamente en horarios programados</label>
                    </div>
                </div>
                
                <button onclick="createProject()">‚ûï Crear Proyecto</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>üìÅ Mis Proyectos</h2>
                </div>
                <div id="projectsList" class="projects-grid"></div>
            </div>
        </div>

        <!-- Posts Tab -->
        <div id="tab-posts" class="tab-content">
            <div class="form-group">
                <label>Seleccionar Proyecto</label>
                <select id="postsProjectSelect" onchange="loadProjectPosts()">
                    <option value="">Selecciona un proyecto...</option>
                </select>
            </div>

            <div id="selectedProjectPosts"></div>
        </div>

        <!-- AI Tab -->
        <div id="tab-ai" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>ü§ñ Generador de Contenido con IA</h2>
                    <button class="outline" onclick="testAIConnection()" style="margin-left: auto;">
                        üîç Probar Conexi√≥n
                    </button>
                </div>
                
                <div id="aiConnectionStatus" style="display:none; margin-bottom: 16px;"></div>
                
                <div class="form-group">
                    <label>Proyecto</label>
                    <select id="aiProjectSelect">
                        <option value="">Selecciona un proyecto...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>URL del contenido</label>
                    <input type="url" id="aiUrl" placeholder="https://tusitio.com/articulo">
                    <small>La IA analizar√° esta URL para generar contenido</small>
                </div>
                
                <div class="form-group">
                    <label>ü§ñ Prompt para la IA (opcional)</label>
                    <textarea id="aiPrompt" rows="4" placeholder="Ej: Crea un post profesional sobre este servicio. Usa tono cercano y menciona garant√≠a. Incluye emojis y hashtags relevantes."></textarea>
                    <small>Define c√≥mo debe la IA generar el contenido. Si dejas vac√≠o, usar√° el prompt del proyecto.</small>
                </div>
                
                <div class="form-group">
                    <label>Contexto adicional (opcional)</label>
                    <textarea id="aiContext" placeholder="Informaci√≥n adicional que quieras que la IA considere..."></textarea>
                </div>
                
                <button onclick="generateContent()">‚ú® Generar Contenido</button>
                
                <div id="aiResult" style="display:none;" class="mt-3">
                    <div class="form-group">
                        <label>T√≠tulo Generado</label>
                        <input type="text" id="aiGeneratedTitle" readonly>
                    </div>
                    <div class="form-group">
                        <label>Mensaje Generado</label>
                        <textarea id="aiGeneratedMessage" rows="4" readonly></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveGeneratedPost()">üíæ Guardar Post</button>
                        <button class="secondary" onclick="generateContent()">üîÑ Regenerar</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>üì¶ Generaci√≥n en Lote</h2>
                </div>
                
                <div class="form-group">
                    <label>Proyecto</label>
                    <select id="aiBulkProjectSelect">
                        <option value="">Selecciona un proyecto...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>URLs (una por l√≠nea)</label>
                    <textarea id="aiBulkUrls" rows="10" placeholder="https://tusitio.com/url1&#10;https://tusitio.com/url2&#10;https://tusitio.com/url3"></textarea>
                    <small>Ingresa una URL por l√≠nea</small>
                </div>
                
                <div class="form-group">
                    <label>ü§ñ Prompt para la IA (opcional)</label>
                    <textarea id="aiBulkPrompt" rows="5" placeholder="Ej: Crea posts sobre servicios t√©cnicos. Usa tono profesional y cercano. Menciona que somos especialistas. Incluye emojis y hashtags #servicio #especialistas"></textarea>
                    <small>Define c√≥mo debe la IA generar el contenido para todas estas URLs. Si dejas vac√≠o, usar√° el prompt del proyecto (si tiene uno).</small>
                </div>
                
                <button onclick="generateBulkContent()">‚ú® Generar Todo el Contenido</button>
                
                <div id="bulkProgress" style="display:none;" class="mt-3">
                    <div class="loading active">
                        <div class="spinner"></div>
                        <p>Generando contenido... <span id="bulkProgressText">0/0</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>
                    <button onclick="loadSettings()">üîÑ Recargar</button>
                </div>
                
                <div class="message info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        <strong>Configuraci√≥n Din√°mica</strong><br>
                        Puedes configurar las credenciales directamente desde este panel. Los cambios se guardan en Cloudflare KV y son aplicados inmediatamente.
                    </div>
                </div>
                
                <h3 class="mb-2">üîë Clave de Administrador</h3>
                <p class="text-gray text-small mb-3">
                    Para guardar la configuraci√≥n necesitas la clave de administrador. Config√∫rala primero con:
                    <code>npx wrangler secret put ADMIN_KEY</code>
                </p>
                
                <div class="form-group">
                    <label>Clave de Administrador *</label>
                    <input type="password" id="adminKey" placeholder="Ingresa la clave de administrador">
                    <small>Esta clave solo se usa para autenticar cambios, no se guarda en el navegador</small>
                </div>
                
                <h3 class="mb-2 mt-3">ü§ñ Proveedor de IA</h3>
                <p class="text-gray text-small mb-3">
                    Selecciona el proveedor de IA que deseas usar para generar contenido autom√°tico.
                </p>
                
                <div class="form-group">
                    <label>Proveedor</label>
                    <select id="aiProvider" onchange="updateModelOptions()">
                        <option value="openai">OpenAI (GPT-3.5 / GPT-4)</option>
                        <option value="gemini">Google Gemini</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Modelo</label>
                    <select id="aiModel">
                        <!-- Se llena din√°micamente seg√∫n el proveedor -->
                    </select>
                    <small class="text-gray">Selecciona el modelo de IA a utilizar</small>
                </div>
                
                <div class="form-group">
                    <label>API Key del Proveedor de IA</label>
                    <input type="password" id="aiApiKey" placeholder="sk-... o AIza...">
                    <small id="aiApiKeyStatus">No configurada</small>
                </div>
                
                <!-- Bot√≥n para probar API -->
                <div style="margin-top: 12px; margin-bottom: 12px;">
                    <button class="primary" onclick="testCurrentAIConfig()" style="width: 100%;">
                        üß™ Probar Configuraci√≥n de IA
                    </button>
                </div>
                
                <!-- Resultado de la prueba -->
                <div id="aiTestResult" style="display: none; margin-top: 12px;"></div>
                
                <div id="aiProviderInfo" class="message info" style="display:none; margin-top: 12px;">
                    <span>üìñ</span>
                    <div id="aiProviderInfoText"></div>
                </div>
                
                <h3 class="mb-2 mt-3">üìò Facebook</h3>
                <p class="text-gray text-small mb-3">
                    Credenciales para publicar en tu fanpage. Consulta 
                    <a href="https://github.com/Jorguitouy/Facebook-Autopost-Cloudflare/blob/master/GUIA-AUTORIZACION-FACEBOOK.md" target="_blank">GUIA-AUTORIZACION-FACEBOOK.md</a>
                    para obtenerlas.
                </p>
                
                <div class="form-group">
                    <label>Page ID</label>
                    <input type="text" id="fbPageId" placeholder="123456789012345">
                    <small id="fbPageIdStatus">No configurado</small>
                </div>
                
                <div class="form-group">
                    <label>Page Access Token</label>
                    <input type="password" id="fbPageAccessToken" placeholder="EAAxxxxx...">
                    <small id="fbPageAccessTokenStatus">No configurado</small>
                </div>
                
                <div class="flex gap-2 mt-3">
                    <button class="success" onclick="saveSettings()">üíæ Guardar Configuraci√≥n</button>
                    <button class="secondary" onclick="resetSettingsForm()">üîÑ Resetear Formulario</button>
                </div>
                
                <hr style="margin: 32px 0; border: none; border-top: 1px solid var(--border);">
                
                <h3 class="mb-2">üìö Documentaci√≥n Adicional</h3>
                
                <div class="form-grid" style="margin-top: 16px;">
                    <button class="outline" onclick="window.open('https://github.com/Jorguitouy/Facebook-Autopost-Cloudflare', '_blank')">
                        üìñ Ver README
                    </button>
                    <button class="outline" onclick="window.open('https://github.com/Jorguitouy/Facebook-Autopost-Cloudflare/blob/master/GUIA-AUTORIZACION-FACEBOOK.md', '_blank')">
                        üîë Gu√≠a OAuth Facebook
                    </button>
                    <button class="outline" onclick="window.open('https://github.com/Jorguitouy/Facebook-Autopost-Cloudflare/blob/master/OPEN-GRAPH-GUIDE.md', '_blank')">
                        üè∑Ô∏è Gu√≠a Open Graph
                    </button>
                </div>
                
                <h3 class="mb-2 mt-3">‚è∞ Horarios de Publicaci√≥n</h3>
                <p class="text-gray text-small mb-3">
                    Los horarios de publicaci√≥n autom√°tica se configuran en el archivo <code>wrangler.toml</code>
                    usando cron triggers. Actualmente:
                </p>
                
                <div class="form-group">
                    <textarea readonly rows="5">9:00 AM UTC - Primera publicaci√≥n del d√≠a
2:00 PM UTC - Segunda publicaci√≥n del d√≠a
7:00 PM UTC - Tercera publicaci√≥n del d√≠a

Para cambiar los horarios, edita el archivo wrangler.toml
y ejecuta: npx wrangler deploy</textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar proyecto -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Proyecto</h2>
                <button class="modal-close" onclick="closeEditProjectModal()">√ó</button>
            </div>
            
            <input type="hidden" id="editProjectId">
            
            <div class="form-group">
                <label>Nombre del Proyecto</label>
                <input type="text" id="editProjectName">
            </div>
            
            <div class="form-group">
                <label>Dominio</label>
                <input type="text" id="editProjectDomain">
            </div>
            
            <div class="form-group">
                <label>Descripci√≥n</label>
                <textarea id="editProjectDescription"></textarea>
            </div>
            
            <div class="form-group">
                <label>URLs del Proyecto (una por l√≠nea)</label>
                <textarea id="editProjectUrls" rows="10" placeholder="https://www.misitio.com/pagina1&#10;https://www.misitio.com/pagina2"></textarea>
                <small>Puedes agregar, editar o eliminar URLs. M√°ximo 500 URLs por proyecto.</small>
            </div>
            
            <div class="form-group">
                <label>ü§ñ Prompt para la IA (opcional)</label>
                <textarea id="editProjectAiPrompt" rows="5" placeholder="Ej: Crea posts sobre servicios t√©cnicos. Usa tono profesional. Incluye emojis y hashtags relevantes."></textarea>
                <small>Define c√≥mo debe la IA generar contenido para las URLs de este proyecto.</small>
            </div>
            
            <!-- Secci√≥n de Facebook -->
            <div class="form-group">
                <label>üìò Conexi√≥n con Facebook</label>
                <div id="facebookStatus" class="facebook-status">
                    <div class="status-disconnected">
                        <span>‚ùå No conectado</span>
                        <button type="button" class="btn-connect-facebook" onclick="connectFacebook()">
                            üìò Conectar Fanpage
                        </button>
                    </div>
                </div>
                <small>Conecta una fanpage para publicar autom√°ticamente.</small>
            </div>
            
            <div class="form-group checkbox-group">
                <input type="checkbox" id="editProjectActive">
                <label>Proyecto activo</label>
            </div>
            
            <div class="flex gap-2 mt-3">
                <button onclick="saveEditProject()">üíæ Guardar Cambios</button>
                <button class="secondary" onclick="closeEditProjectModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script src="/dashboard.js" defer></script>
</body>
</html>
